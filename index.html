<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Music</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      cursor: pointer;
    }
    .sort-arrow {
      margin-left: 5px;
    }
    #searchBar {
      padding: 8px;
      font-size: 16px;
      width: 300px;
      margin-right: 10px;
    }
    #visibleCount {
      font-size: 16px;
    }
  </style>
</head>
<body>

<h2>Welcome to my music page! Here are all the musics I know and like.</h2>
<input type="text" id="searchBar" placeholder="Search a music...">
<span id="visibleCount">Loading...</span>

<table id="musicTable">
  <thead>
    <tr>
      <th onclick="toggleSortByName()">
        Music name <span id="nameSortArrow" class="sort-arrow">⬆</span>
      </th>
      <th onclick="toggleSortByDuration()">
        Listen to it <span id="durationSortArrow" class="sort-arrow">⬍</span>
      </th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const GITHUB_API_URL = "https://api.github.com/repos/SuperMimi73/SuperMimi73.github.io/contents/Music";

  let ascendingName = true;
  let ascendingDuration = true;
  let musicData = [];

  async function fetchMusicFiles() {
    const res = await fetch(GITHUB_API_URL);
    const data = await res.json();
    const mp3Files = data.filter(file => file.name.endsWith(".mp3"));
    musicData = await Promise.all(mp3Files.map(async file => {
      const audio = document.createElement("audio");
      audio.src = file.download_url;
      const duration = await getAudioDuration(audio.src);
      return {
        name: file.name.replace(/\.mp3$/, ""),
        url: file.download_url,
        duration: duration
      };
    }));
    renderTable();
  }

  function getAudioDuration(src) {
    return new Promise(resolve => {
      const audio = new Audio();
      audio.src = src;
      audio.addEventListener("loadedmetadata", () => resolve(audio.duration || 0));
      audio.addEventListener("error", () => resolve(0));
    });
  }

  function renderTable(filtered = "") {
    const tbody = document.querySelector("#musicTable tbody");
    tbody.innerHTML = "";

    const visibleMusic = musicData
      .filter(m => m.name.toLowerCase().includes(filtered.toLowerCase()));

    visibleMusic.forEach(music => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${music.name}</td>
        <td><audio controls src="${music.url}"></audio></td>
      `;
      tbody.appendChild(row);
    });

    document.getElementById("visibleCount").textContent = `${visibleMusic.length} music${visibleMusic.length !== 1 ? 's' : ''}`;
  }

  function toggleSortByName() {
    ascendingName = !ascendingName;
    musicData.sort((a, b) => {
      return ascendingName
        ? a.name.localeCompare(b.name)
        : b.name.localeCompare(a.name);
    });
    document.getElementById("nameSortArrow").textContent = ascendingName ? "⬆" : "⬇";
    document.getElementById("durationSortArrow").textContent = "⬍";
    renderTable(document.getElementById("searchBar").value);
  }

  function toggleSortByDuration() {
    ascendingDuration = !ascendingDuration;
    musicData.sort((a, b) => {
      return ascendingDuration ? a.duration - b.duration : b.duration - a.duration;
    });
    document.getElementById("durationSortArrow").textContent = ascendingDuration ? "⬆" : "⬇";
    document.getElementById("nameSortArrow").textContent = "⬍";
    renderTable(document.getElementById("searchBar").value);
  }

  document.getElementById("searchBar").addEventListener("input", () => {
    renderTable(document.getElementById("searchBar").value);
  });

  window.addEventListener("DOMContentLoaded", async () => {
    await fetchMusicFiles();
    toggleSortByName(); // Tri alphabétique par défaut
  });
</script>

</body>
</html>
